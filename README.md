# Rotate-pie
Rotate-pie based on F2 &amp; G

<center>

<img src="https://f2-pie-test.oss-cn-hangzhou.aliyuncs.com/Rotate-Animation.gif" width="320">

</center>

#### 一、设计需求

&emsp;&emsp;F2库在一些可视化组件的无线端的交互体验不足，需要定制一些组件与展现效果。研究基于G，封装一个类似Roambi饼图，具有滚动与交互效果。

#### 二、实现方案

##### 1. 功能拆分

（1）静态饼状图，由数据驱动，根据数据的分布情况映射成几何图像。

（2）**饼状图的动态交互效果，根据用户的手势，分为panstart、panmove、panend三个阶段，分析三个阶段触发的不同的效果，进行函数的封装**（下面的动画效果拆分部分会详细分析）。

（3）**组件需要一个固定的位置，每当饼状图的这个部分经过固定位置时，获取当前对应元素的数据，去动态更新数据标签部分。**

##### 2. 动画效果拆分

（1）用户在刚接触图表，尚未开启滑动的时候（即panstart时），需要初始化总体旋转的角度（totalAngle=0），记录用户滑动初始的角度（newMouseAngle）。

（2）用户在滑动饼状图时（即panmove时），饼状图的元素需要根据用户的手势进行相应的动效，所以需要计算每一次手势移动出发时产生的角度差（即diffAngle），同时更新每一次移动导致的totalAngle的变化（如果没有手势操作后的后续滑动，该参数将用于最后更新饼图的状态）。然后，饼图跟随手势移动。

（3）用户在完成手势操作后，饼状图需要进行一部分的滑动效果，用于提升用户的使用体验。

- **饼状图最后滑动的时长、以及滑动的速度，其实取决于用户滑动手势的最后时刻的速度，如果速度越快，相应的饼状图转动速度越快，动画的duration越久（但需要设定阈值，避免动画时间过久导致用户体验降低）**。
- 饼状图最后时刻的滑动速度由用户滑动饼状图最后时刻的diffAngle这一参数反映，因为diffAngle越大，说明在最后时刻，用户手势操作的速度越快，对应的交互效果也不同。

（4）在完成所有的滑动效果后，为了让用户有更明确的数据指向，因此需要计算当前元素悬停的位置，并且调整元素，使箭头指向元素的中心位置。指向中心位置，通过获取所有元素的起始角度（startAngle）和终止角度（endAngle）来判定最终的悬停元素，之后设置动画来实现悬停。

（5）在饼图运动的过程中，需要和Legend产生联动，便于用户观察原始数据。首先计算每个元素的起始角度和终止角度来找到运动过程中箭头指向的元素，然后根据该元素对象上的name、value和color去更新Label。

#### 三、方案思考

&emsp;&emsp;在饼图的原始数据触发过程中，需要展示箭头指向的元素的name和value，对于元素与数据展示部分有两种实现方式，**一种是封装自定义Interaction，结合Tooltip的trigerOn的配置项实现；一种是根据自定义Legend和元素的对象属性来实现。**下面对两种方法进行比较：

##### 1. 封装自定义Interaction

&emsp;&emsp;F2的Tooltip的triggerOn配置项表示tooltip出现的触发行为，常用的有'touchstart'，'touchmove'等，但是没有合适的交互行为类能够直接满足需求。

&emsp;&emsp;**F2提供一套交互行为的注册机制，同时交互行为也可提供配置化的反馈（结果）。因此需要封装一个自定义的Interaction，在元素经过箭头指向的位置时触发，借此来更新Tooltip**。

- 优点：通过封装自定义的Interaction，对于该部分的Interaction复用提供便利。同时封装Interaction，不暴露给用户，代码更简洁，在系统实现方面更方便。
- 缺点：这种Interaction较为特殊，一般只有在可交互的饼图才会使用，因此可复用性不大；对于自定义的Interaction，需要借助公有属性、方法去实现、封装自定义交互行为类，之后需要对其进行注册、使用。在实现方面，逻辑复杂度和难度也大于方案2。

##### 2. Legend的custom配置

&emsp;&emsp;**F2的Legend的API提供设置图例项的name、value和color，只需要将其custom设置为true，之后在组件内通过封装函数即可在触发的时候调用。**demo中即采用该方法实现。

- 优点：通过F2原生的Legend，通过配置项和触发函数的封装即可实现该功能，从实现上来看，该方法的实现难度小于方案1；同时代码的逻辑也比方案1简单。
- 缺点：使用Legend来实现数据的交互展示效果，会占用Legend本身的展示效果，比如在特定的使用场景下，需要展示所有数据的Legend，同时要实现数据的交互展示，这种方法就可能导致Legend本身的展示效果没法体现。

&emsp;&emsp;针对两种方法的比较、实现的复杂度和项目需求匹配，使用方案2实现，方案1在后续的学习中将会尝试。

#### 四、实现步骤

##### 1. 饼状图的初始化

&emsp;&emsp;静态饼状图的实现需要通过数据实现几何图形和组件整体的映射，基于F2来初始化静态饼状图。

##### 2. 饼状图的完整动态效果

&emsp;&emsp;饼状图的完整动态效果包括用户在进行交互操作时的手势决定。从用户接触屏幕开始，到进行交互手势的运动，再到完成交互手势，需要封装不同的动态效果。

具体的动态效果包含以下几种：

- 饼状图伴随交互手势的旋转移动，主要计算diffAngle，然后设置动画效果；
- 交互手势完成后，根据交互手势的最后速度，实现饼状图的滑动效果；

- 饼图完成滑动后，箭头需要指向当前饼图元素的中间；

##### 3. 饼图与Legend的交互

&emsp;&emsp;饼图在旋转的过程中，需要显示箭头指向的元素的name、value和color，用来更新Legend的元素。
